services:
  mam-audiofinder:
    build:
      context: .
      target: production  # Use production stage, not testing
      args:
        PUID: ${PUID}
        PGID: ${PGID}
    image: ghcr.io/raygan/mam-audiofinder:latest
    container_name: mam-audiofinder
    networks:
      - nginx-network # only had if you want to run on local network
    ports:
      - "${APP_PORT}:8080"
    env_file:
      - .env
    user: "${PUID}:${PGID}"
    environment:
      UMASK: "${UMASK}"
      # Override DATA_DIR to use container path, not host path
      # (Host path is used by docker-compose for volume mount only)
      DATA_DIR: "/data"
    volumes:
      - ${DATA_DIR}:/data
      - ${MEDIA_ROOT}:/media
    restart: unless-stopped

  selenium:
    image: selenium/standalone-chrome:latest
    container_name: mam-audiofinder-selenium
    ports:
      - "4444:4444"
      - "7900:7900"  # VNC server for debugging (optional)
    shm_size: 2gb
    environment:
      - SE_NODE_MAX_SESSIONS=5
      - SE_NODE_SESSION_TIMEOUT=300
      - SE_VNC_NO_PASSWORD=1
    restart: unless-stopped
    profiles:
      - testing  # Only start with: docker compose --profile testing up

networks:
   nginx-network:
      external: true
